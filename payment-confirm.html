<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Payment - SnugglePaw</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages/payment.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">Snuggle<span>Paw</span></a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="services.html">Services</a>
                <a href="booking.html">Book Now</a>
                <a href="about.html">About Us</a>
                <a href="contact.html">Contact</a>
            </div>
            <button class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Payment Confirmation -->
    <div class="payment-container">
        <div class="payment-header">
            <i class="fas fa-credit-card"></i>
            <h1>Review & Pay</h1>
            <p>Please review your booking details and complete the payment to confirm your booking.</p>
        </div>
        
        <div class="booking-summary">
            <div class="summary-header">
                <h2>Appointment Details</h2>
                <button id="backButton" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Back to Booking
                </button>
            </div>
            
            <div class="booking-details">
                <div class="detail-group">
                    <h3>Pet Name</h3>
                    <p id="petName">-</p>
                </div>
                <div class="detail-group">
                    <h3>Service</h3>
                    <p id="serviceType">-</p>
                </div>
                <div class="detail-group">
                    <h3>Size</h3>
                    <p id="petSize">-</p>
                </div>
                <div class="detail-group">
                    <h3>Date</h3>
                    <p id="appointmentDate">-</p>
                </div>
                <div class="detail-group" id="endDateGroup" style="display:none;">
                    <h3>End Date</h3>
                    <p id="appointmentEndDate">-</p>
                </div>
                <div class="detail-group">
                    <h3>Time</h3>
                    <p id="appointmentTime">-</p>
                </div>
                <div class="detail-group" id="stayGroup" style="display:none;">
                    <h3>Stay</h3>
                    <p id="stayText">-</p>
                </div>
            </div>
            
            <div class="payment-amount">
                <div class="amount-row">
                    <span>Service Fee</span>
                    <span id="serviceFee">RM 0.00</span>
                </div>
                <div class="amount-row">
                    <span>Tax (10%)</span>
                    <span id="taxAmount">RM 0.00</span>
                </div>
                <div class="amount-row total">
                    <span>Total Amount</span>
                    <span id="totalAmount">RM 0.00</span>
                </div>
            </div>
            
            <!-- Payment Actions -->
            <div class="payment-actions">
                <div id="paypal-buttons"></div>
                <div class="payment-processing">
                    <div class="spinner"></div>
                    <p>Processing your payment...</p>
                </div>
            </div>
            
            <div class="payment-success">
                <i class="fas fa-check-circle"></i>
                <h3>Payment Successful!</h3>
                <p>Your appointment has been confirmed.</p>
                <div class="btn-container" style="margin-top: 20px;">
                    <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
                    <a href="booking.html" class="btn btn-outline">Book Another Appointment</a>
                </div>
            </div>
        </div>
    </div>

    <!-- PayPal JS SDK (Sandbox) -->
    <script src="https://www.paypal.com/sdk/js?client-id=Ab7qAX3zgshP7xG_TW3xvvOVqDNy2bz7L9fdPwZGkUc0AYmiElpi-45dJw-qPQ6f52uhTJP0-ATbmeRp&currency=MYR"></script>

    <script>
        // Global function to get pet size from database
        async function getPetSizeFromDatabase(petName) {
            try {
                // Import Firebase modules
                const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js');
                const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js');
                const { app } = await import('./js/firebase-config.js');
                
                const auth = getAuth(app);
                const db = getDatabase(app);
                
                return new Promise((resolve) => {
                    // Check if user is logged in
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            console.log('No user logged in');
                            document.getElementById('petSize').textContent = 'Not specified';
                            return resolve();
                        }

                        try {
                            // Reference to the user's pets
                            const userPetsRef = ref(db, `users/${user.uid}/pets`);
                            
                            // Get all pets
                            const snapshot = await get(userPetsRef);
                            if (snapshot.exists()) {
                                const pets = snapshot.val();
                                // Find the pet by name (case insensitive)
                                const pet = Object.values(pets).find(p => 
                                    p && p.name && p.name.toLowerCase() === petName.toLowerCase()
                                );
                                
                                if (pet && pet.size) {
                                    document.getElementById('petSize').textContent = pet.size;
                                } else {
                                    document.getElementById('petSize').textContent = 'Not specified';
                                }
                            } else {
                                document.getElementById('petSize').textContent = 'Not specified';
                            }
                        } catch (error) {
                            console.error('Error fetching pet size:', error);
                            document.getElementById('petSize').textContent = 'Error loading';
                        }
                        resolve();
                    });
                });
            } catch (error) {
                console.error('Error loading Firebase modules:', error);
                document.getElementById('petSize').textContent = 'Error loading';
                return Promise.resolve();
            }
        }

        // Parse URL parameters to get booking details
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            let amount = 0;
            let service = '';
            let total = 0;
            
            // Update the UI with booking details from URL parameters
            if (urlParams.has('pet')) {
                document.getElementById('petName').textContent = decodeURIComponent(urlParams.get('pet'));
            }
            if (urlParams.has('service')) {
                service = decodeURIComponent(urlParams.get('service'));
                document.getElementById('serviceType').textContent = service;
            }
            if (urlParams.has('pet')) {
                const petName = decodeURIComponent(urlParams.get('pet'));
                // Get pet size from URL parameter
                if (urlParams.has('size')) {
                    const size = decodeURIComponent(urlParams.get('size'));
                    if (size && size !== 'undefined') {
                        // Display the size from URL parameter
                        document.getElementById('petSize').textContent = size;
                    } else if (window.getPetSizeFromDatabase) {
                        // If no size in URL, try to get from database
                        getPetSizeFromDatabase(petName);
                    } else {
                        document.getElementById('petSize').textContent = 'Not specified';
                    }
                } else if (window.getPetSizeFromDatabase) {
                    // No size in URL, try to get from database
                    getPetSizeFromDatabase(petName);
                } else {
                    document.getElementById('petSize').textContent = 'Not specified';
                }
            } else {
                document.getElementById('petSize').textContent = 'Not specified';
            }
            if (urlParams.has('date')) {
                const date = new Date(urlParams.get('date'));
                document.getElementById('appointmentDate').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            if (urlParams.has('endDate')) {
                const endDateParam = urlParams.get('endDate');
                if (endDateParam) {
                    const end = new Date(endDateParam);
                    document.getElementById('appointmentEndDate').textContent = end.toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    document.getElementById('endDateGroup').style.display = '';
                }
            }
            if (urlParams.has('time')) {
                document.getElementById('appointmentTime').textContent = urlParams.get('time');
            }
            if (urlParams.has('stayDays')) {
                const days = parseInt(urlParams.get('stayDays'), 10);
                if (!isNaN(days) && days > 0) {
                    document.getElementById('stayText').textContent = `${days} days (${Math.max(days-1,0)} nights)`;
                    document.getElementById('stayGroup').style.display = '';
                }
            }
            if (urlParams.has('amount')) {
                amount = parseFloat(urlParams.get('amount'));
                const tax = amount * 0.1; // 10% tax
                total = amount + tax;
                
                document.getElementById('serviceFee').textContent = `RM ${amount.toFixed(2)}`;
                document.getElementById('taxAmount').textContent = `RM ${tax.toFixed(2)}`;
                document.getElementById('totalAmount').textContent = `RM ${total.toFixed(2)}`;
                // expose totals for invoice
                window.paymentTotals = { amount, tax, total, currency: 'MYR' };
            }
            // expose booking params for invoice
            window.bookingParams = Object.fromEntries(urlParams.entries());
            
            // Store booking in local storage for dashboard
            if (urlParams.has('pet') && urlParams.has('service') && urlParams.has('date') && urlParams.has('time')) {
                const booking = {
                    id: 'b' + Date.now(),
                    pet: urlParams.get('pet'),
                    service: service,
                    date: urlParams.get('date'),
                    time: urlParams.get('time'),
                    status: 'pending_payment',
                    amount: amount.toFixed(2),
                    createdAt: new Date().toISOString(),
                };
                
                // Save to local storage
                const bookings = JSON.parse(localStorage.getItem('petBookings') || '[]');
                bookings.push(booking);
                localStorage.setItem('petBookings', JSON.stringify(bookings));
                window.currentBookingId = booking.id;
            }

            // Init PayPal Buttons
            if (window.paypal) {
                paypal.Buttons({
                    style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                description: service,
                                amount: {
                                    value: total.toFixed(2),
                                    currency_code: 'MYR',
                                    breakdown: {
                                        item_total: {
                                            value: amount.toFixed(2),
                                            currency_code: 'MYR'
                                        },
                                        tax_total: {
                                            value: (total - amount).toFixed(2),
                                            currency_code: 'MYR'
                                        }
                                    }
                                },
                                items: [{
                                    name: service,
                                    unit_amount: {
                                        value: amount.toFixed(2),
                                        currency_code: 'MYR'
                                    },
                                    quantity: '1',
                                    category: 'DIGITAL_GOODS'
                                }]
                            }]
                        });
                    },
                    onApprove: async function(data, actions) {
                        try {
                            // Show loading state
                            document.querySelector('.payment-actions').style.display = 'none';
                            document.querySelector('.payment-processing').style.display = 'block';
                            
                            // Capture the order
                            const details = await actions.order.capture();
                            
                            // Save to Firebase
                            const { appointmentId, paymentId, invoiceId, invoiceNumber } = await window.saveAppointmentToDB(details.id);
                            
                            // Update booking status
                            updateBookingStatus('paid', paymentId);
                            
                            // Show success message
                            document.querySelector('.payment-processing').style.display = 'none';
                            document.querySelector('.payment-success').style.display = 'block';
                            
                            // Enable download invoice button
                            const downloadBtn = document.getElementById('downloadInvoiceBtn');
                            if (downloadBtn) {
                                downloadBtn.style.display = 'inline-block';
                                downloadBtn.onclick = () => window.open(`/invoice.html?id=${invoiceId}`, '_blank');
                            }
                            
                            return details;
                        } catch (error) {
                            console.error('Payment processing error:', error);
                            alert('Failed to process payment. Please try again or contact support.');
                            // Reset UI
                            document.querySelector('.payment-processing').style.display = 'none';
                            document.querySelector('.payment-actions').style.display = 'block';
                            throw error;
                        }
                    },
                    onError: function(err) {
                        console.error('PayPal error:', err);
                        alert('An error occurred while processing your payment. Please try again.');
                        document.querySelector('.payment-processing').style.display = 'none';
                        document.querySelector('.payment-actions').style.display = 'block';
                    }
                }).render('#paypal-buttons');
            }
        });
        
        // Function to update booking status
        function updateBookingStatus(status, paymentId = '') {
            const bookings = JSON.parse(localStorage.getItem('petBookings') || '[]');
            const bookingIndex = bookings.findIndex(b => b.id === window.currentBookingId);
            if (bookingIndex !== -1) {
                bookings[bookingIndex].status = status;
                if (paymentId) {
                    bookings[bookingIndex].paymentId = paymentId;
                    bookings[bookingIndex].paidAt = new Date().toISOString();
                }
                localStorage.setItem('petBookings', JSON.stringify(bookings));
            }
        }

    </script>

    <!-- Firebase save to Realtime Database after successful PayPal capture -->
    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
        import { getDatabase, ref, push, set, update } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
        import { app } from './js/firebase-config.js';

        const auth = getAuth(app);
        const db = getDatabase(app);

        // Expose a function to be called from the PayPal onApprove handler
        window.saveAppointmentToDB = async function saveAppointmentToDB(paymentId) {
            return new Promise((resolve, reject) => {
                onAuthStateChanged(auth, async (user) => {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const petName = urlParams.get('pet') || '';
                        const serviceName = urlParams.get('service') || '';
                        const date = urlParams.get('date') || '';
                        const time = urlParams.get('time') || '';
                        const baseAmount = parseFloat(urlParams.get('amount') || '0');
                        const tax = baseAmount * 0.1; // 10% tax
                        const totalAmount = baseAmount + tax;
                        const size = urlParams.get('size') || '';
                        const type = urlParams.get('type') || '';
                        const endDate = urlParams.get('endDate') || '';
                        const stayDays = urlParams.get('stayDays') || '';
                        const species = urlParams.get('species') || '';
                        const notes = urlParams.get('notes') || '';
                        const nowIso = new Date().toISOString();
                        
                        if (!user || !user.uid) {
                            throw new Error('User not authenticated');
                        }
                        
                        window.lastUserId = user.uid;
                        
                        // 1. Create appointment
                        const appt = {
                            userId: user.uid,
                            petName,
                            serviceName,
                            date,
                            time,
                            price: totalAmount,
                            basePrice: baseAmount,
                            tax: tax,
                            size,
                            type,
                            endDate,
                            stayDays: stayDays ? Number(stayDays) : undefined,
                            species: species || undefined,
                            status: 'confirmed',
                            paymentId: paymentId || '',
                            notes: notes || undefined,
                            createdAt: nowIso,
                            updatedAt: nowIso
                        };
                        
                        // Remove empty/undefined fields
                        Object.keys(appt).forEach(k => (appt[k] === undefined || appt[k] === '') && delete appt[k]);

                        // Save appointment
                        const newApptRef = push(ref(db, 'appointments'));
                        await set(newApptRef, appt);
                        const appointmentId = newApptRef.key;
                        window.lastAppointmentId = appointmentId;

                        // 2. Create payment record
                        const paymentRef = push(ref(db, 'payments'));
                        const paymentData = {
                            id: paymentId || `pay_${Date.now()}`,
                            userId: user.uid,
                            appointmentId: appointmentId,
                            amount: totalAmount,
                            baseAmount: baseAmount,
                            tax: tax,
                            status: 'completed',
                            method: 'paypal',
                            paymentDate: nowIso,
                            createdAt: nowIso,
                            updatedAt: nowIso
                        };
                        await set(paymentRef, paymentData);

                        // 3. Create invoice
                        const invoiceRef = push(ref(db, 'invoices'));
                        const invoiceNumber = `INV-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(invoiceRef.key).substring(0, 8).toUpperCase()}`;
                        const invoiceData = {
                            number: invoiceNumber,
                            date: nowIso,
                            userId: user.uid,
                            appointmentId: appointmentId,
                            paymentId: paymentId || paymentData.id,
                            petName: petName,
                            service: serviceName,
                            amount: totalAmount,
                            baseAmount: baseAmount,
                            tax: tax,
                            status: 'paid',
                            createdAt: nowIso,
                            updatedAt: nowIso
                        };
                        await set(invoiceRef, invoiceData);

                        // Update appointment with payment and invoice references
                        await update(newApptRef, {
                            paymentId: paymentData.id,
                            invoiceId: invoiceRef.key,
                            updatedAt: new Date().toISOString()
                        });

                        resolve({ 
                            appointmentId, 
                            paymentId: paymentData.id, 
                            invoiceId: invoiceRef.key,
                            invoiceNumber
                        });
                    } catch (e) {
                        console.error('Failed to save booking data:', e);
                        reject(e);
                    }
                });
            });
        };
    </script>
    
    <!-- Add loading spinner styles -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .payment-processing {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .payment-processing p {
            color: #666;
            font-size: 16px;
        }
    </style>

    <!-- Create invoice in DB and open printable preview -->
    <script>
        // Back button functionality
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    // Get all URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const formData = {};
                    
                    // Save all URL parameters to sessionStorage
                    urlParams.forEach((value, key) => {
                        formData[key] = value;
                    });
                    
                    // Save the form data to sessionStorage
                    sessionStorage.setItem('bookingFormData', JSON.stringify(formData));
                    
                    // Add a flag to indicate we're coming back from payment
                    sessionStorage.setItem('returningFromPayment', 'true');
                    
                    // Navigate back to the booking page
                    window.location.href = 'booking.html';
                });
            }
        });
    </script>

    <script type="module">
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
        import { getDatabase, ref, push, set, update } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
        import { app } from './js/firebase-config.js';

        const auth2 = getAuth(app);
        const db2 = getDatabase(app);

        window.createInvoiceInDB = async function createInvoiceInDB(appointmentId, paymentId, totals) {
            const user = auth2.currentUser;
            const uid = (user && user.uid) || window.lastUserId || '';
            const number = 'INV-' + Date.now();
            const now = new Date().toISOString();
            const params = window.bookingParams || {};
            const invoice = {
                number,
                date: now,
                service: params.service || 'Service',
                amount: (totals?.total ?? 0).toFixed(2),
                currency: totals?.currency || 'MYR',
                status: 'paid',
                appointmentId: appointmentId || window.lastAppointmentId || '',
                paymentId: paymentId || '',
                pet: params.pet || '',
                userId: uid
            };
            const invRef = push(ref(db2, 'invoices'));
            await set(invRef, invoice);
            window.lastInvoiceId = invRef.key;
            return invRef.key;
        }

        // Save admin-side payment summary under /payments/{paymentId}
        window.savePaymentForAdmin = async function savePaymentForAdmin(paymentId, appointmentId, totals) {
            const user = auth2.currentUser;
            const uid = (user && user.uid) || window.lastUserId || '';
            const params = window.bookingParams || {};
            const payload = {
                paymentId,
                appointmentId: appointmentId || window.lastAppointmentId || '',
                userId: uid,
                pet: params.pet || '',
                service: params.service || '',
                date: params.date || '',
                time: params.time || '',
                amount: Number((totals?.total ?? 0).toFixed(2)),
                currency: totals?.currency || 'MYR',
                status: 'paid',
                createdAt: new Date().toISOString()
            };
            await update(ref(db2, `payments/${paymentId}`), payload);
        };
    </script>
    <!-- Navbar auth controller -->
    <script type="module" src="js/navbar-auth.js"></script>
</body>
</html>
